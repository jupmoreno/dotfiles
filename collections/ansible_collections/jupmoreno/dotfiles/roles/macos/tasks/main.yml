- name: Configure macOS system preferences
  become: true
  block:
    - name: Configure General UI/UX settings
      block:
        - name: Click in the scroll bar to jump to the spot that's clicked
          community.general.defaults:
            key: AppleScrollerPagingBehavior
            type: int
            value: 1

        - name: Expand save panel by default
          community.general.defaults:
            key: "{{ item }}"
            type: bool
            value: true
          loop:
            - NSNavPanelExpandedStateForSaveMode
            - NSNavPanelExpandedStateForSaveMode2

        - name: Expand print panel by default
          community.general.defaults:
            key: "{{ item }}"
            type: bool
            value: true
          loop:
            - PMPrintingExpandedStateForPrint
            - PMPrintingExpandedStateForPrint2

        - name: Save to disk by default (not iCloud)
          community.general.defaults:
            key: NSDocumentSaveNewDocumentsToCloud
            type: bool
            value: false

        - name: Quit printer app when finished
          community.general.defaults:
            key: "Quit When Finished"
            type: bool
            value: true
            domain: com.apple.print.PrintingPrefs

        - name: Disable automatic termination of inactive apps
          community.general.defaults:
            key: NSDisableAutomaticTermination
            type: bool
            value: true

        - name: Set Help Viewer to non-floating mode
          community.general.defaults:
            key: DevMode
            type: bool
            value: true
            domain: com.apple.helpviewer

        - name: Disable crash reporter
          community.general.defaults:
            key: DialogType
            type: string
            value: "none"
            domain: com.apple.CrashReporter

        - name: Set action on double-clicking window
          community.general.defaults:
            key: AppleActionOnDoubleClick
            type: string
            value: "Maximize"

        - name: Enable dark mode
          community.general.defaults:
            key: AppleInterfaceStyle
            type: string
            value: "Dark"

    - name: Configure General animations
      block:
        - name: Disable animated focus ring
          community.general.defaults:
            key: NSUseAnimatedFocusRing
            type: bool
            value: false

        - name: Display dialogs instantly
          community.general.defaults:
            key: NSWindowResizeTime
            type: float
            value: 0.001

        - name: Disable window animations
          community.general.defaults:
            key: NSAutomaticWindowAnimationsEnabled
            type: bool
            value: false

    - name: Configure keyboard and locale settings
      block:
        - name: Disable automatic capitalization
          community.general.defaults:
            key: NSAutomaticCapitalizationEnabled
            type: bool
            value: false

        - name: Disable smart quotes
          community.general.defaults:
            key: NSAutomaticQuoteSubstitutionEnabled
            type: bool
            value: false

        - name: Disable smart dashes
          community.general.defaults:
            key: NSAutomaticDashSubstitutionEnabled
            type: bool
            value: false

        - name: Disable automatic period substitution
          community.general.defaults:
            key: NSAutomaticPeriodSubstitutionEnabled
            type: bool
            value: false

        - name: Disable auto-correct
          community.general.defaults:
            key: NSAutomaticSpellingCorrectionEnabled
            type: bool
            value: false

        - name: Disable press-and-hold for keys
          community.general.defaults:
            key: ApplePressAndHoldEnabled
            type: bool
            value: false

        - name: Set fast keyboard repeat rate
          community.general.defaults:
            key: KeyRepeat
            type: int
            value: 3

        - name: Set initial key repeat delay
          community.general.defaults:
            key: InitialKeyRepeat
            type: int
            value: 15

        - name: Enable full keyboard access (e.g. enable Tab in modal dialogs)
          community.general.defaults:
            key: AppleKeyboardUIMode
            type: int
            value: 3

        - name: Set metric units
          community.general.defaults:
            key: AppleMetricUnits
            type: bool
            value: true

        - name: Set measurement units to centimeters
          community.general.defaults:
            key: AppleMeasurementUnits
            type: string
            value: "Centimeters"

        - name: Set temperature unit to Celsius
          community.general.defaults:
            key: AppleTemperatureUnit
            type: string
            value: "Celsius"

    - name: Configure menu bar settings
      block:
        - name: Show day of week and 24-hour clock
          community.general.defaults:
            key: DateFormat
            type: string
            value: "EEE dd HH:mm:ss"
            domain: com.apple.menuextra.clock

        - name: Hide Siri
          community.general.defaults:
            key: StatusMenuVisible
            type: int
            value: 0
            domain: com.apple.Siri

        - name: Disable menu bar full screen animation
          community.general.defaults:
            key: NSToolbarFullScreenAnimationDuration
            type: float
            value: 0

    - name: Configure Finder settings
      block:
        - name: Set default location for new Finder windows
          community.general.defaults:
            key: NewWindowTarget
            type: string
            value: "PfLo"
            domain: com.apple.finder

        - name: Set default path for new Finder windows
          community.general.defaults:
            key: NewWindowTargetPath
            type: string
            value: "file://{{ ansible_env.HOME }}/"
            domain: com.apple.finder

        - name: Show all filename extensions
          community.general.defaults:
            key: AppleShowAllExtensions
            type: bool
            value: true

        - name: Disable extension change warning
          community.general.defaults:
            key: FXEnableExtensionChangeWarning
            type: bool
            value: false
            domain: com.apple.finder

        - name: Show status bar
          community.general.defaults:
            key: ShowStatusBar
            type: bool
            value: true
            domain: com.apple.finder

        - name: Show path bar
          community.general.defaults:
            key: ShowPathbar
            type: bool
            value: true
            domain: com.apple.finder

        - name: Show /Volumes folder
          command: sudo chflags nohidden /Volumes
          become: true

        - name: Disable all animations
          community.general.defaults:
            key: DisableAllAnimations
            type: bool
            value: true
            domain: com.apple.finder

        - name: Disable Quick Look animations
          community.general.defaults:
            key: QLPanelAnimationDuration
            type: float
            value: 0

        - name: Keep folders on top when sorting
          community.general.defaults:
            key: _FXSortFoldersFirst
            type: bool
            value: true
            domain: com.apple.finder

        - name: Set default search scope to current folder
          community.general.defaults:
            key: FXDefaultSearchScope
            type: string
            value: "SCcf"
            domain: com.apple.finder

        - name: Avoid .DS_Store on network volumes
          community.general.defaults:
            key: DSDontWriteNetworkStores
            type: bool
            value: true
            domain: com.apple.desktopservices

        - name: Avoid .DS_Store on USB volumes
          community.general.defaults:
            key: DSDontWriteUSBStores
            type: bool
            value: true
            domain: com.apple.desktopservices

        - name: Enable spring loading for directories
          community.general.defaults:
            key: com.apple.springing.enabled
            type: bool
            value: true

        - name: Reduce spring loading delay
          community.general.defaults:
            key: com.apple.springing.delay
            type: float
            value: 0.1

        - name: Remove toolbar title rollover delay
          community.general.defaults:
            key: NSToolbarTitleViewRolloverDelay
            type: float
            value: 0

        - name: Auto-open new Finder window for mounted volumes
          block:
            - community.general.defaults:
                domain: com.apple.frameworks.diskimages
                settings:
                  auto-open-ro-root: true
                  auto-open-rw-root: true
                type: dict
            - community.general.defaults:
                key: OpenWindowForNewRemovableDisk
                type: bool
                value: true
                domain: com.apple.finder

        - name: Use icons view by default
          community.general.defaults:
            key: FXPreferredViewStyle
            type: string
            value: "icnv"
            domain: com.apple.finder

        - name: Expand File Info panes
          community.general.defaults:
            key: FXInfoPanesExpanded
            type: dict
            value:
              General: true
              OpenWith: true
              Privileges: true
            domain: com.apple.finder

        - name: Configure Finder icon view settings
          block:
            - name: Set desktop icon view settings
              command: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:showItemInfo true" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon view settings
              command: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:showItemInfo true" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon view settings (secondary)
              command: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:showItemInfo true" ~/Library/Preferences/com.apple.finder.plist

            - name: Set desktop icon arrangement
              command: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon arrangement
              command: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon arrangement (secondary)
              command: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:arrangeBy name" ~/Library/Preferences/com.apple.finder.plist

            - name: Set desktop icon grid spacing
              command: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:gridSpacing 50" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon grid spacing
              command: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:gridSpacing 50" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon grid spacing (secondary)
              command: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:gridSpacing 50" ~/Library/Preferences/com.apple.finder.plist

            - name: Set desktop icon size
              command: /usr/libexec/PlistBuddy -c "Set :DesktopViewSettings:IconViewSettings:iconSize 80" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon size
              command: /usr/libexec/PlistBuddy -c "Set :FK_StandardViewSettings:IconViewSettings:iconSize 80" ~/Library/Preferences/com.apple.finder.plist

            - name: Set standard icon size (secondary)
              command: /usr/libexec/PlistBuddy -c "Set :StandardViewSettings:IconViewSettings:iconSize 80" ~/Library/Preferences/com.apple.finder.plist

    - name: Configure screen settings
      block:
        - name: Require password after screen saver
          community.general.defaults:
            key: askForPassword
            type: int
            value: 1
            domain: com.apple.screensaver

        - name: Set password delay to 1 second
          community.general.defaults:
            key: askForPasswordDelay
            type: int
            value: 1
            domain: com.apple.screensaver

        - name: Set screen saver delay to 5 minutes
          community.general.defaults:
            key: idleTime
            type: int
            value: 300
            domain: com.apple.screensaver
            host: current

    - name: Configure screenshot settings
      block:
        - name: Create Screenshots directory
          file:
            path: "{{ ansible_env.HOME }}/Screenshots"
            state: directory
            mode: '0755'

        - name: Set screenshot location
          community.general.defaults:
            key: location
            type: string
            value: "{{ ansible_env.HOME }}/Screenshots"
            domain: com.apple.screencapture

        - name: Disable shadow in screenshots
          community.general.defaults:
            key: disable-shadow
            type: bool
            value: true
            domain: com.apple.screencapture

        - name: Set screenshot format to PNG
          community.general.defaults:
            key: type
            type: string
            value: "png"
            domain: com.apple.screencapture

    - name: Configure energy saving
      block:
        - name: Set display sleep to 10 minutes
          command: sudo pmset -a displaysleep 10
          become: true

    - name: Configure Dock settings
      block:
        - name: Auto-hide Dock
          community.general.defaults:
            key: autohide
            type: bool
            value: true
            domain: com.apple.dock

        - name: Set Dock autohide time modifier
          community.general.defaults:
            key: autohide-time-modifier
            type: float
            value: 0.2
            domain: com.apple.dock

        - name: Set Dock autohide delay
          community.general.defaults:
            key: autohide-delay
            type: float
            value: 0
            domain: com.apple.dock

        - name: Set Dock icon size
          community.general.defaults:
            key: tilesize
            type: int
            value: 64
            domain: com.apple.dock

        - name: Hide recently used apps
          community.general.defaults:
            key: show-recents
            type: bool
            value: false
            domain: com.apple.dock

        - name: Set minimize effect to scale
          community.general.defaults:
            key: mineffect
            type: string
            value: "scale"
            domain: com.apple.dock

        - name: Enable scroll to open
          community.general.defaults:
            key: scroll-to-open
            type: bool
            value: true
            domain: com.apple.dock

        - name: Enable highlight hover effect
          community.general.defaults:
            key: mouse-over-hilite-stack
            type: bool
            value: true
            domain: com.apple.dock

        - name: Enable spring loading for Dock items
          community.general.defaults:
            key: enable-spring-load-actions-on-all-items
            type: bool
            value: true
            domain: com.apple.dock

        - name: Show process indicators
          community.general.defaults:
            key: show-process-indicators
            type: bool
            value: true
            domain: com.apple.dock

        - name: Clear persistent apps
          community.general.defaults:
            key: persistent-apps
            type: array
            value: []
            domain: com.apple.dock
          run_once: true

        - name: Make hidden app icons translucent
          community.general.defaults:
            key: showhidden
            type: bool
            value: true
            domain: com.apple.dock

        - name: Disable launch animation
          community.general.defaults:
            key: launchanim
            type: bool
            value: false
            domain: com.apple.dock

    - name: Configure Mission Control
      block:
        - name: Speed up Mission Control animations
          community.general.defaults:
            key: expose-animation-duration
            type: float
            value: 0.05
            domain: com.apple.dock

        - name: Don't group windows by application
          community.general.defaults:
            key: expose-group-by-app
            type: bool
            value: false
            domain: com.apple.dock

        - name: Don't rearrange Spaces automatically
          community.general.defaults:
            key: mru-spaces
            type: bool
            value: false
            domain: com.apple.dock

        # Hot Corners config values: 0=No action, 2=Mission Control, 3=App Windows, 4=Desktop, 5=Start Screen Saver, 6=Disable Screen Saver, 7=Dashboard, 10=Sleep Display, 11=Launchpad, 12=Notification Center. Modifier: 0=None.
        - name: Configure hot corners
          community.general.defaults:
            domain: com.apple.dock
            type: int
          loop:
            - { key: wvous-tl-corner, value: 0 }
            - { key: wvous-tl-modifier, value: 0 }
            - { key: wvous-tr-corner, value: 12 }
            - { key: wvous-tr-modifier, value: 0 }
            - { key: wvous-bl-corner, value: 11 }
            - { key: wvous-bl-modifier, value: 0 }
            - { key: wvous-br-corner, value: 4 }
            - { key: wvous-br-modifier, value: 0 }
          loop_control:
            label: "{{ item.key }}"
          args:
            key: "{{ item.key }}"
            value: "{{ item.value }}"

    - name: Configure Spotlight
      block:
        - name: Configure Spotlight search results
          community.general.defaults:
            key: orderedItems
            type: array
            value:
              - enabled: 1
                name: "APPLICATIONS"
              - enabled: 0
                name: "MENU_SPOTLIGHT_SUGGESTIONS"
              - enabled: 0
                name: "MENU_CONVERSION"
              - enabled: 1
                name: "MENU_EXPRESSION"
              - enabled: 0
                name: "MENU_DEFINITION"
              - enabled: 1
                name: "SYSTEM_PREFS"
              - enabled: 0
                name: "DOCUMENTS"
              - enabled: 0
                name: "DIRECTORIES"
              - enabled: 0
                name: "PRESENTATIONS"
              - enabled: 0
                name: "SPREADSHEETS"
              - enabled: 0
                name: "PDF"
              - enabled: 0
                name: "MESSAGES"
              - enabled: 0
                name: "CONTACT"
              - enabled: 0
                name: "EVENT_TODO"
              - enabled: 0
                name: "IMAGES"
              - enabled: 0
                name: "BOOKMARKS"
              - enabled: 0
                name: "MUSIC"
              - enabled: 0
                name: "MOVIES"
              - enabled: 0
                name: "FONTS"
              - enabled: 0
                name: "MENU_OTHER"
            domain: com.apple.Spotlight

    - name: Configure Launchpad
      block:
        - name: Disable Launchpad show animation
          community.general.defaults:
            key: springboard-show-duration
            type: float
            value: 0
            domain: com.apple.dock

        - name: Disable Launchpad page animation
          community.general.defaults:
            key: springboard-page-duration
            type: float
            value: 0
            domain: com.apple.dock

    - name: Configure App Store and updates
      block:
        - name: Enable WebKit Developer Tools in App Store
          community.general.defaults:
            key: WebKitDeveloperExtras
            type: bool
            value: true
            domain: com.apple.appstore

        - name: Enable Debug Menu in App Store
          community.general.defaults:
            key: ShowDebugMenu
            type: bool
            value: true
            domain: com.apple.appstore

        - name: Enable automatic update check
          community.general.defaults:
            key: AutomaticCheckEnabled
            type: bool
            value: true
            domain: com.apple.SoftwareUpdate

        - name: Check for updates daily
          community.general.defaults:
            key: ScheduleFrequency
            type: int
            value: 1
            domain: com.apple.SoftwareUpdate

        - name: Download updates in background
          community.general.defaults:
            key: AutomaticDownload
            type: int
            value: 1
            domain: com.apple.SoftwareUpdate

        - name: Install critical updates
          community.general.defaults:
            key: CriticalUpdateInstall
            type: int
            value: 1
            domain: com.apple.SoftwareUpdate

        - name: Turn on app auto-update
          community.general.defaults:
            key: AutoUpdate
            type: bool
            value: true
            domain: com.apple.commerce

        - name: Allow App Store to reboot on updates
          community.general.defaults:
            key: AutoUpdateRestartRequired
            type: bool
            value: true
            domain: com.apple.commerce

    - name: Configure Terminal
      block:
        - name: Set Terminal encoding to UTF-8
          community.general.defaults:
            key: StringEncodings
            type: array
            value: [4]
            domain: com.apple.terminal

        - name: Enable Secure Keyboard Entry
          community.general.defaults:
            key: SecureKeyboardEntry
            type: bool
            value: true
            domain: com.apple.terminal

        - name: Disable line marks
          community.general.defaults:
            key: ShowLineMarks
            type: int
            value: 0
            domain: com.apple.Terminal

    - name: Configure Activity Monitor
      block:
        - name: Show main window when launching
          community.general.defaults:
            key: OpenMainWindow
            type: bool
            value: true
            domain: com.apple.ActivityMonitor

        - name: Visualize CPU usage in Dock icon
          community.general.defaults:
            key: IconType
            type: int
            value: 5
            domain: com.apple.ActivityMonitor

        - name: Show all processes
          community.general.defaults:
            key: ShowCategory
            type: int
            value: 0
            domain: com.apple.ActivityMonitor

        - name: Sort by CPU usage
          community.general.defaults:
            key: SortColumn
            type: string
            value: "CPUUsage"
            domain: com.apple.ActivityMonitor

        - name: Set sort direction
          community.general.defaults:
            key: SortDirection
            type: int
            value: 0
            domain: com.apple.ActivityMonitor

    - name: Configure TextEdit
      block:
        - name: Use plain text mode by default
          community.general.defaults:
            key: RichText
            type: int
            value: 0
            domain: com.apple.TextEdit

        - name: Use UTF-8 encoding
          community.general.defaults:
            key: PlainTextEncoding
            type: int
            value: 4
            domain: com.apple.TextEdit

        - name: Use UTF-8 encoding for writing
          community.general.defaults:
            key: PlainTextEncodingForWrite
            type: int
            value: 4
            domain: com.apple.TextEdit

    - name: Configure other applications
      block:
        - name: Enable debug menu in Disk Utility
          community.general.defaults:
            key: DUDebugMenuEnabled
            type: bool
            value: true
            domain: com.apple.DiskUtility

        - name: Enable advanced image options in Disk Utility
          community.general.defaults:
            key: advanced-image-options
            type: bool
            value: true
            domain: com.apple.DiskUtility

        - name: Stop iTunes from responding to media keys
          command: launchctl unload -w /System/Library/LaunchAgents/com.apple.rcd.plist
          ignore_errors: true

  tags:
    - system-config
